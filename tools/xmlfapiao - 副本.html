<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½å‘ç¥¨å¤„ç†ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary-color: #409EFF;
            --success-color: #67C23A;
            --bg-color: #f8f9fa;
        }

        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--primary-color);
            color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #333;
            color: white;
            padding: 12px 30px;
            text-align: center;
            font-size: 14px;
            z-index: 1000;
        }

        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            padding-top: 70px;
            padding-bottom: 60px;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }

        .upload-section {
            border: 2px dashed var(--primary-color);
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            background: #f0f7ff;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .custom-upload-btn {
            background: var(--primary-color);
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            margin: 10px;
            border: none;
        }

        #progress {
            height: 20px;
            background: #ebeef5;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        #progressBar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            transition: width 0.3s ease;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border: 1px solid #ddd;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        .data-table thead {
            background-color: #f8f9fa;
        }

        .total-row {
            background-color: #f1f8ff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="header">
        <a href="/" style="color: white; text-decoration: none;">ğŸ  ä¸»é¡µ</a>
        <span style="float: right">XMLå‘ç¥¨æ™ºèƒ½å¤„ç†ç³»ç»Ÿ</span>
    </div>

    <div class="container">
        <div class="upload-section">
            <h2>ğŸ“ ç”µå­å‘ç¥¨å¤„ç†ç³»ç»Ÿ</h2>
            <label class="custom-upload-btn">
                <input type="file" id="xmlFiles" accept=".xml" multiple>
                é€‰æ‹©å‘ç¥¨æ–‡ä»¶
            </label>
            <button class="custom-upload-btn" onclick="processFiles()">å¼€å§‹å¤„ç†</button>
            <span class="file-counter" id="fileCounter"></span>
            
            <div id="progress">
                <div id="progressBar"></div>
            </div>
            <p>æ”¯æŒæ‰¹é‡ä¸Šä¼ XMLå‘ç¥¨æ–‡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰</p>
        </div>
        
        <div id="resultSection" style="display: none;">
            <h3>ğŸ“Š å‘ç¥¨æ˜ç»†è¡¨</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>å‘ç¥¨å·ç </th>
                        <th>å¼€ç¥¨æ—¥æœŸ</th>
                        <th>ä¹°æ–¹åç§°</th>
                        <th>å–æ–¹åç§°</th>
                        <th>å•†å“åç§°</th>
                        <th>è§„æ ¼å‹å·</th>
                        <th>æ•°é‡</th>
                        <th>å•ä»·</th>
                        <th>é‡‘é¢</th>
                        <th>ç¨ç‡</th>
                        <th>ç¨é¢</th>
                        <th>ä»·ç¨åˆè®¡</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>

            <div id="monthlyStats"></div>
            <button class="custom-upload-btn" onclick="exportToCSV()">â¬‡ï¸ å¯¼å‡ºä¸ºCSV</button>
        </div>
    </div>

    <div id="footer">
        @é€†æµé”‹åˆ€ QQï¼š418271053 | æ•°æ®å®‰å…¨æœ¬åœ°å¤„ç†
    </div>

    <script>
        let invoiceData = [];
        let statistics = { totalAmount: 0, totalTax: 0, totalAll: 0 };

        // æ–‡ä»¶é€‰æ‹©ç›‘å¬
        document.getElementById('xmlFiles').addEventListener('change', function(e) {
            const count = e.target.files.length;
            document.getElementById('fileCounter').textContent = count > 0 
                ? `å·²é€‰æ‹© ${count} ä¸ªæ–‡ä»¶` 
                : '';
        });

        async function processFiles() {
            const files = document.getElementById('xmlFiles').files;
            if (files.length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªXMLæ–‡ä»¶');
                return;
            }

            // é‡ç½®æ•°æ®
            invoiceData = [];
            statistics = { totalAmount: 0, totalTax: 0, totalAll: 0 };
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = '0%';
            
            for (let i = 0; i < files.length; i++) {
                await new Promise((resolve) => {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(e.target.result, "text/xml");

                            // è§£æåŸºæœ¬ä¿¡æ¯
                            const basicInfo = {
                                invoiceNumber: getXmlValue(xmlDoc, 'InvoiceNumber'),
                                issueDate: getXmlValue(xmlDoc, 'IssueTime'),
                                buyer: getXmlValue(xmlDoc, 'BuyerName'),
                                seller: getXmlValue(xmlDoc, 'SellerName'),
                                totalAmount: parseFloat(getXmlValue(xmlDoc, 'TotalAmWithoutTax') || 0),
                                totalTax: parseFloat(getXmlValue(xmlDoc, 'TotalTaxAm') || 0),
                                totalAll: parseFloat(getXmlValue(xmlDoc, 'TotalTax-includedAmount') || 0)
                            };

                            // ç»Ÿè®¡ç´¯åŠ 
                            statistics.totalAmount += basicInfo.totalAmount;
                            statistics.totalTax += basicInfo.totalTax;
                            statistics.totalAll += basicInfo.totalAll;

                            // è§£æå•†å“æ˜ç»†
                            const items = xmlDoc.getElementsByTagName('IssuItemInformation');
                            for (const item of items) {
                                invoiceData.push({
                                    ...basicInfo,
                                    itemName: getChildValue(item, 'ItemName'),
                                    spec: getChildValue(item, 'SpecMod'),
                                    quantity: parseFloat(getChildValue(item, 'Quantity') || 0),
                                    unitPrice: parseFloat(getChildValue(item, 'UnPrice') || 0),
                                    taxRate: (parseFloat(getChildValue(item, 'TaxRate') || 0) * 100).toFixed(2) + '%',
                                    itemTax: parseFloat(getChildValue(item, 'ComTaxAm') || 0),
                                    itemTotal: parseFloat(getChildValue(item, 'TotaltaxIncludedAmount') || 0)
                                });
                            }
                        } catch (error) {
                            console.error('æ–‡ä»¶è§£æé”™è¯¯:', error);
                        }
                        resolve();
                    };
                    reader.readAsText(file);
                });
                progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
            }

            showResults();
            generateMonthlyReport();
        }

        function getXmlValue(xmlDoc, tagName) {
            const node = xmlDoc.getElementsByTagName(tagName)[0];
            return node ? node.textContent : '';
        }

        function getChildValue(parent, tagName) {
            const node = parent.getElementsByTagName(tagName)[0];
            return node ? node.textContent : '';
        }

        function showResults() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            invoiceData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.invoiceNumber}</td>
                    <td>${item.issueDate}</td>
                    <td>${item.buyer}</td>
                    <td>${item.seller}</td>
                    <td>${item.itemName}</td>
                    <td>${item.spec}</td>
                    <td>${item.quantity.toFixed(2)}</td>
                    <td>${item.unitPrice.toFixed(2)}</td>
                    <td>${item.totalAmount.toFixed(2)}</td>
                    <td>${item.taxRate}</td>
                    <td>${item.totalTax.toFixed(2)}</td>
                    <td>${item.totalAll.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('resultSection').style.display = 'block';
        }

        function generateMonthlyReport() {
            const monthlyData = {};

            invoiceData.forEach(item => {
                const month = item.issueDate.substring(0, 7).replace("-", "å¹´") + "æœˆ";
                if (!monthlyData[month]) {
                    monthlyData[month] = {
                        items: {},
                        totalAmount: 0,
                        totalTax: 0,
                        totalAll: 0,
                        invoices: new Set()
                    };
                }
                
                monthlyData[month].invoices.add(item.invoiceNumber);
                monthlyData[month].totalAmount += item.totalAmount;
                monthlyData[month].totalTax += item.totalTax;
                monthlyData[month].totalAll += item.totalAll;

                if (!monthlyData[month].items[item.itemName]) {
                    monthlyData[month].items[item.itemName] = {
                        amount: 0,
                        tax: 0,
                        total: 0,
                        count: 0
                    };
                }
                
                const itemData = monthlyData[month].items[item.itemName];
                itemData.amount += item.totalAmount;
                itemData.tax += item.totalTax;
                itemData.total += item.totalAll;
                itemData.count++;
            });

            const statsDiv = document.getElementById('monthlyStats');
            statsDiv.innerHTML = `
                <h3>ğŸ“… æœˆåº¦ç»Ÿè®¡æŠ¥è¡¨</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th rowspan="2">æœˆä»½</th>
                            <th rowspan="2">å•†å“åç§°</th>
                            <th colspan="3">é‡‘é¢ç»Ÿè®¡</th>
                            <th rowspan="2">å¼€ç¥¨æ¬¡æ•°</th>
                        </tr>
                        <tr>
                            <th>é‡‘é¢åˆè®¡</th>
                            <th>ç¨é¢åˆè®¡</th>
                            <th>ä»·ç¨åˆè®¡</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(monthlyData).map(([month, data]) => `
                            <tr class="total-row">
                                <td>${month}</td>
                                <td colspan="5">æœ¬æœˆå‘ç¥¨æ•°é‡ï¼š${data.invoices.size}</td>
                            </tr>
                            ${Object.entries(data.items).map(([itemName, item]) => `
                                <tr>
                                    <td></td>
                                    <td>${itemName}</td>
                                    <td>${item.amount.toFixed(2)}</td>
                                    <td>${item.tax.toFixed(2)}</td>
                                    <td>${item.total.toFixed(2)}</td>
                                    <td>${item.count}</td>
                                </tr>
                            `).join('')}
                            <tr class="total-row">
                                <td colspan="2">æœ¬æœˆåˆè®¡</td>
                                <td>${data.totalAmount.toFixed(2)}</td>
                                <td>${data.totalTax.toFixed(2)}</td>
                                <td>${data.totalAll.toFixed(2)}</td>
                                <td>${data.invoices.size}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function exportToCSV() {
            const csvContent = [
                ['å‘ç¥¨å·ç ', 'å¼€ç¥¨æ—¥æœŸ', 'ä¹°æ–¹åç§°', 'å–æ–¹åç§°', 'å•†å“åç§°', 'è§„æ ¼å‹å·', 'æ•°é‡', 'å•ä»·', 'é‡‘é¢', 'ç¨ç‡', 'ç¨é¢', 'ä»·ç¨åˆè®¡'].join(','),
                ...invoiceData.map(item => [
                    item.invoiceNumber,
                    item.issueDate,
                    `"${item.buyer}"`,
                    `"${item.seller}"`,
                    `"${item.itemName}"`,
                    item.spec,
                    item.quantity.toFixed(2),
                    item.unitPrice.toFixed(2),
                    item.totalAmount.toFixed(2),
                    item.taxRate,
                    item.totalTax.toFixed(2),
                    item.totalAll.toFixed(2)
                ].join(','))
            ].join('\n');

            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å‘ç¥¨æ˜ç»†_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }
    </script>
</body>
</html>