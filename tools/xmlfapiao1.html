<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½å‘ç¥¨å¤„ç†ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary-color: #409EFF;
            --success-color: #67C23A;
            --bg-color: #f8f9fa;
        }

        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--primary-color);
            color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        #footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #333;
            color: white;
            padding: 12px 30px;
            text-align: center;
            font-size: 14px;
            z-index: 1000;
        }

        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            padding-top: 70px;
            padding-bottom: 60px;
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }

        .file-counter {
            color: var(--primary-color);
            font-weight: bold;
            margin-left: 15px;
        }

        /* å…¶ä»–æ ·å¼ä¿æŒä¸å˜... */
    </style>
</head>
<body>
    <div id="header">
        <a href="/" style="color: white; text-decoration: none;">ğŸ  ä¸»é¡µ</a>
        <span style="float: right">XMLå‘ç¥¨æ™ºèƒ½å¤„ç†ç³»ç»Ÿ</span>
    </div>

    <div class="container">
        <div class="upload-section">
            <h2>ğŸ“ ç”µå­å‘ç¥¨å¤„ç†ç³»ç»Ÿ</h2>
            <label class="custom-upload-btn">
                <input type="file" id="xmlFiles" accept=".xml" multiple>
                é€‰æ‹©å‘ç¥¨æ–‡ä»¶
            </label>
            <button class="custom-upload-btn" onclick="processFiles()">å¼€å§‹å¤„ç†</button>
            <span class="file-counter" id="fileCounter"></span>
            
            <div id="progress">
                <div id="progressBar"></div>
            </div>
            <p>æ”¯æŒæ‰¹é‡ä¸Šä¼ XMLå‘ç¥¨æ–‡ä»¶ï¼ˆå¯å¤šé€‰ï¼‰</p>
        </div>
        
        <div id="resultSection" style="display: none;">
            <h3>ğŸ“Š å‘ç¥¨æ˜ç»†è¡¨</h3>
            <table id="resultTable">
                <thead>
                    <tr>
                        <th>å‘ç¥¨å·ç </th>
                        <th>å¼€ç¥¨æ—¥æœŸ</th>
                        <th>ä¹°æ–¹åç§°</th>
                        <th>å–æ–¹åç§°</th>
                        <th>å•†å“åç§°</th>
                        <th>è§„æ ¼å‹å·</th>
                        <th>æ•°é‡</th>
                        <th>å•ä»·</th>
                        <th>é‡‘é¢</th>
                        <th>ç¨ç‡</th>
                        <th>ç¨é¢</th>
                        <th>ä»·ç¨åˆè®¡</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>

            <div class="statistics-card">
                <div class="stat-item">æ€»é‡‘é¢ï¼š<span id="totalAmount">0.00</span></div>
                <div class="stat-item">æ€»ç¨é¢ï¼š<span id="totalTax">0.00</span></div>
                <div class="stat-item">æ€»ä»·ç¨åˆè®¡ï¼š<span id="totalAll">0.00</span></div>
            </div>

            <button class="export-btn" onclick="exportToCSV()">â¬‡ï¸ å¯¼å‡ºä¸ºCSV</button>
        </div>
    </div>

    <div id="footer">
        @é€†æµé”‹åˆ€ QQï¼š418271053 | æ•°æ®å®‰å…¨æœ¬åœ°å¤„ç†
    </div>

    <script>
        let invoiceData = [];
        let statistics = {
            totalAmount: 0,
            totalTax: 0,
            totalAll: 0
        };

        // æ–‡ä»¶é€‰æ‹©ç›‘å¬
        document.getElementById('xmlFiles').addEventListener('change', function(e) {
            const count = e.target.files.length;
            document.getElementById('fileCounter').textContent = count > 0 
                ? `å·²é€‰æ‹© ${count} ä¸ªæ–‡ä»¶` 
                : '';
        });

        async function processFiles() {
            const files = document.getElementById('xmlFiles').files;
            if (files.length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªXMLæ–‡ä»¶');
                return;
            }

            // é‡ç½®æ•°æ®
            invoiceData = [];
            statistics = { totalAmount: 0, totalTax: 0, totalAll: 0 };
            const progressBar = document.getElementById('progressBar');
            
            // ä½¿ç”¨Promiseç¡®ä¿é¡ºåºå¤„ç†
            for (const file of files) {
                await new Promise((resolve) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(e.target.result, "text/xml");

                            // è§£æåŸºæœ¬ä¿¡æ¯
                            const basicInfo = {
                                invoiceNumber: getXmlValue(xmlDoc, 'InvoiceNumber'),
                                issueDate: getXmlValue(xmlDoc, 'IssueTime'),
                                buyer: getXmlValue(xmlDoc, 'BuyerName'),
                                seller: getXmlValue(xmlDoc, 'SellerName'),
                                totalAmount: parseFloat(getXmlValue(xmlDoc, 'TotalAmWithoutTax') || 0),
                                totalTax: parseFloat(getXmlValue(xmlDoc, 'TotalTaxAm') || 0),
                                totalAll: parseFloat(getXmlValue(xmlDoc, 'TotalTax-includedAmount') || 0)
                            };

                            // ç´¯åŠ ç»Ÿè®¡ä¿¡æ¯
                            statistics.totalAmount += basicInfo.totalAmount;
                            statistics.totalTax += basicInfo.totalTax;
                            statistics.totalAll += basicInfo.totalAll;

                            // è§£æå•†å“æ˜ç»†
                            const items = xmlDoc.getElementsByTagName('IssuItemInformation');
                            for (const item of items) {
                                invoiceData.push({
                                    ...basicInfo,
                                    itemName: getChildValue(item, 'ItemName'),
                                    spec: getChildValue(item, 'SpecMod'),
                                    quantity: parseFloat(getChildValue(item, 'Quantity') || 0),
                                    unitPrice: parseFloat(getChildValue(item, 'UnPrice') || 0),
                                    taxRate: (parseFloat(getChildValue(item, 'TaxRate') || 0) * 100).toFixed(2) + '%',
                                    itemTax: parseFloat(getChildValue(item, 'ComTaxAm') || 0),
                                    itemTotal: parseFloat(getChildValue(item, 'TotaltaxIncludedAmount') || 0)
                                });
                            }
                        } catch (error) {
                            console.error('æ–‡ä»¶è§£æé”™è¯¯:', error);
                        }
                        resolve();
                    };
                    
                    reader.readAsText(file);
                });
                updateProgress(invoiceData.length, files.length);
            }

            showResults();
        }

        // XMLè§£æè¾…åŠ©å‡½æ•°
        function getXmlValue(xmlDoc, tagName) {
            const node = xmlDoc.getElementsByTagName(tagName)[0];
            return node ? node.textContent : '';
        }

        function getChildValue(parent, tagName) {
            const node = parent.getElementsByTagName(tagName)[0];
            return node ? node.textContent : '';
        }

        function updateProgress(current, total) {
            const progress = (current / total) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        function showResults() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            invoiceData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.invoiceNumber}</td>
                    <td>${item.issueDate}</td>
                    <td>${item.buyer}</td>
                    <td>${item.seller}</td>
                    <td>${item.itemName}</td>
                    <td>${item.spec}</td>
                    <td>${item.quantity.toFixed(2)}</td>
                    <td>${item.unitPrice.toFixed(2)}</td>
                    <td>${item.totalAmount.toFixed(2)}</td>
                    <td>${item.taxRate}</td>
                    <td>${item.totalTax.toFixed(2)}</td>
                    <td>${item.totalAll.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('totalAmount').textContent = statistics.totalAmount.toFixed(2);
            document.getElementById('totalTax').textContent = statistics.totalTax.toFixed(2);
            document.getElementById('totalAll').textContent = statistics.totalAll.toFixed(2);

            document.getElementById('resultSection').style.display = 'block';
        }

        function exportToCSV() {
            const csvContent = [
                ['å‘ç¥¨å·ç ', 'å¼€ç¥¨æ—¥æœŸ', 'ä¹°æ–¹åç§°', 'å–æ–¹åç§°', 'å•†å“åç§°', 'è§„æ ¼å‹å·', 'æ•°é‡', 'å•ä»·', 'é‡‘é¢', 'ç¨ç‡', 'ç¨é¢', 'ä»·ç¨åˆè®¡'].join(','),
                ...invoiceData.map(item => [
                    item.invoiceNumber,
                    item.issueDate,
                    `"${item.buyer}"`,
                    `"${item.seller}"`,
                    `"${item.itemName}"`,
                    item.spec,
                    item.quantity.toFixed(2),
                    item.unitPrice.toFixed(2),
                    item.totalAmount.toFixed(2),
                    item.taxRate,
                    item.totalTax.toFixed(2),
                    item.totalAll.toFixed(2)
                ].join(','))
            ].join('\n');

            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å‘ç¥¨æ˜ç»†_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }
    </script>
</body>
</html>